var keyWords=["iphone","samsung","nokia"],apiBaseUrl="https://admin.techspecs.io/api",foundWord=[];const config={};let debug=!1;config.limit=4,config.dId="",config.isTA=!1,config.isCE=!1,chrome.extension.onMessage.addListener(function(e,o,t){if("custom"===e.from&&"closeTooltip"===e.action)$("#chromeTooltipWrapper").html("");else if("custom"===e.from&&"renderWidget"===e.action){appendWidget('<iframe src="https://techspecs.io/embed/'+e.dId+'" width="880" height="520" frameborder="0" scrolling="yes" style="max-width: 100%;height:520px;"></iframe>')}});var chromeTooltipWrapperHtml='\n<div id="chromeTooltipWrapper"></div>\n',tooltipIframe='<iframe id=\'techspecs_iframe\' frameborder="0" scrolling="no" ></iframe>';chrome.storage.sync.set({chromeTooltipBlockSites:[]});var $body=$("body");function initHeightLightTool(){$("textarea").length>0&&0===$("textarea.chromeTA").length&&$("textarea").addClass("chromeTA"),$("[contenteditable]").length>0&&0===$(".chromeCE[contenteditable]").length&&$("[contenteditable]").addClass("chromeCE"),chrome.storage.sync.get(["chromeTooltipBlockSites"],function(e){var o=e.chromeTooltipBlockSites;(!o||o&&-1===o.indexOf(window.location.hostname))&&(0===$(".hwt-container.hwtTA").length&&$(".chromeTA").length>0&&(config.isTA=!0,$(".chromeTA").highlightWithinTextarea({highlight:searchApiForTA,renderToolip:renderToolipTA,className:"chromeTooltipMark markForTA"})),0===$(".hwt-container.hwtCE").length&&$(".chromeCE").length>0&&(config.isCE=!0,$(".chromeCE").highlightWithinContentEditable({highlight:searchApiForCE,renderToolip:renderToolipCE,className:"chromeTooltipMark markForCE"})))})}function hideChromeTooltip(){$("#chromeTooltipWrapper",$body).html("")}function placeCaretAtEnd(e){if(e.focus(),void 0!==window.getSelection&&void 0!==document.createRange){var o=document.createRange();o.selectNodeContents(e),o.collapse(!1);var t=window.getSelection();t.removeAllRanges(),t.addRange(o)}else if(void 0!==document.body.createTextRange){var r=document.body.createTextRange();r.moveToElementText(e),r.collapse(!1),r.select()}}function widgetForTA(e){var o=$(".chromeTA");o.val(function(o,t){return t+="\n"+e+"\n"}).trigger("input").scrollTop(o[0].scrollHeight),setTimeout(function(){o[0].focus(),o[0].setSelectionRange(o[0].value.length,o[0].value.length)},800),hideChromeTooltip()}function widgetForCE(e){var o=$(".chromeCE"),t=o.html();t+=`<div>${`${e}`.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</div>`,o.html(t),o.append("<div />"),markWords(),setTimeout(function(){if(placeCaretAtEnd(o[0]),window.getSelection){var e=window.getSelection(),t=e.getRangeAt(0),r=document.createElement("br");document.createTextNode(" ");return t.deleteContents(),t.insertNode(r),t.collapse(!1),e.removeAllRanges(),e.addRange(t),!1}},800),hideChromeTooltip()}function appendWidget(e){"CE"===$("#chromeTooltipWrapper",$body).data("currRenderCon")?widgetForCE(e):widgetForTA(e),hideChromeTooltip()}function resizeIframe(e,o){o.css("height",e.h+"px"),o.css("width",e.w+"px")}function renderFrame(e,o){e.attr("src",chrome.runtime.getURL("index.html")),e.ready(function(){var t=setInterval(function(){chrome.runtime.sendMessage({action:"getDim",data:{dId:config.dId}},function(r){clearInterval(t),r&&r.dim&&(appendTooltipArrow(o),config.dim=r.dim,resizeIframe(r.dim,e))})},100)})}function appendTooltipArrow(e){e.append('<div class="chrome-tooltip-arrow"></div>')}function renderToolipTA(e){$("#chromeTooltipWrapper",$body).length>0&&hideChromeTooltip();var o=$(".chromeTA").prop("selectionEnd")-1,t=e&&e.length>0?e:$(".hwt-backdrop.hwtTA").find('mark[data-index="i_'+o+'"]');if(t.length>0){var r=t.offset();0===$("#chromeTooltipWrapper",$body).length&&$body.append(chromeTooltipWrapperHtml);var n=$("#chromeTooltipWrapper",$body);n.css({top:r.top+t.outerHeight()+10,left:r.left}),n.html(tooltipIframe).data("currRenderCon","TA"),renderFrame($("#techspecs_iframe"),n)}else $("#chromeTooltipWrapper",$body).length>0&&hideChromeTooltip()}function renderToolipCE(e){debug&&console.log("renderToolip",e),$("#chromeTooltipWrapper",$body).length>0&&hideChromeTooltip();var o=getCaretPosition($(".chromeCE")[0])-1,t=e&&e.length>0?e:$(".hwt-backdrop.hwtCE").find('mark[data-index="i_'+o+'"]');if(t.length>0){var r=t.offset();0===$("#chromeTooltipWrapper",$body).length&&$body.append(chromeTooltipWrapperHtml);var n=$("#chromeTooltipWrapper",$body);n.css({top:r.top+t.outerHeight()+10,left:r.left}),n.html(tooltipIframe).data("currRenderCon","CE"),renderFrame($("#techspecs_iframe"),n)}else $("#chromeTooltipWrapper",$body).length>0&&hideChromeTooltip()}async function asyncForEach(e,o){for(let t=0;t<e.length;t++)await o(e[t],t,e)}function ajaxPromise(e){return new Promise(o=>{$.ajax({type:"POST",url:apiBaseUrl+"/extension_auto_suggest",data:{text:e,desc:e}}).done(function(t){o({result:t.result,s:e})})})}function fuzzySearch(e,o){return o.toLowerCase().indexOf(e.toLowerCase())>-1}async function getData(e){debug&&console.log("ajaxPromise start",e);const o=await ajaxPromise($.trim(e.join(" ")));return debug&&console.log("ajaxPromise end",o.s),o.result&&o.result.device_id&&fuzzySearch(o.s,o.result.device_name)?(config.dId=o.result.device_id,-1===foundWord.indexOf(o.s)?(foundWord.push(o.s),debug&&console.log("foundWord",foundWord),foundWord):foundWord):(e.shift(),e.length>0?(debug&&console.log("getData sync",e),""===$.trim(e)?foundWord:void await getData(e)):(debug&&console.log("Done"),foundWord))}function decodeEntities(e){const o=document.createElement("textarea");return o.innerHTML=e,o.className="temp_textarea",o.value}async function searchApiForTA(e){try{if(config.cpos=$(".chromeTA").prop("selectionStart"),e&&/\s$/.test(e.slice(config.cpos-1,config.cpos))&&e.length>=config.limit){const e=$("<div>"+decodeEntities($(".hwt-highlights.hwtTA").html())+"</div>");if(e.find("iframe").remove(),debug&&console.log("spacecheck",e.html()),config.afterMarkStr=e.html().split("</mark>").reverse()[0],$(".temp_textarea").remove(),debug&&console.log("spacecheck",config.afterMarkStr),config.afterMarkStr.length>=config.limit){config.arr=config.afterMarkStr.split(" ");const e=await getData(config.arr.slice(Math.max(config.arr.length-4,0)));return debug&&console.log("fw",typeof e),e||foundWord}}return foundWord}catch(e){debug&&console.log(e)}}function markWords(e){let o,t=$(".chromeCE").html().replace(/<\/?strong>/gi,"");if(debug&&console.log("foundWord",foundWord),$.each(foundWord,function(e,r){o=new RegExp("\\b("+r+")\\b","gi"),t=t.replace(o,function(o){return debug&&console.log("WORD MATCH:",o),'<mark data-index="i_'+e+'" class="chromeTooltipMark markForCE">'+o+"</mark>"})}),debug&&console.log("HTML:",t),debug&&console.log("----"),$(".hwt-highlights.hwtCE").html(t),e&&foundWord.length>0){const o=foundWord.slice(-1)[0],t=e.indexOf(o);if(t>-1){const r=e.length-o.length-1;debug&&console.log(typeof r),debug&&console.log(typeof t),r===t&&$(".chromeTooltipMark.markForCE").length>0&&renderToolipCE($(".chromeTooltipMark.markForCE").last())}}}async function searchApiForCE(e){try{var o=window.getSelection();if(o.focusNode&&o.focusNode.nodeValue&&(e=o.focusNode.nodeValue)&&e.length>=config.limit){debug&&console.log(config);const o=$("<div>"+e+"</div>");if(o.find("iframe").remove(),debug&&console.log("spacecheck",o.html()),config.afterMarkStr=o.html(),$(".temp_textarea").remove(),debug&&console.log("spacecheck",config.afterMarkStr),config.afterMarkStr.length>=config.limit){config.afterMarkStr=decodeEntities(config.afterMarkStr),config.arr=config.afterMarkStr.split(" ");const o=await getData(config.arr.slice(Math.max(config.arr.length-4,0)));return debug&&console.log("fw",typeof o),markWords(e),o||foundWord}}return foundWord}catch(e){debug&&console.log(e)}}function searchProductApi(e){url=apiBaseUrl+"/product/quick-search?text="+e,$.ajax({type:"POST",url:url,dataType:"json"}).done(function(e){null!=e.result&&e.result.length>0&&($productName.append(html),getProductDetailsById(e.result[0].device_id))})}function getProductDetailsById(e){debug&&console.log(apiBaseUrl+"/product/detail/"+e+"/1"),$.ajax({type:"GET",url:apiBaseUrl+"/product/detail/"+e+"/1",dataType:"json"}).done(function(e){debug&&console.log(e);var o=e.result.name,t=e.result.specification;debug&&console.log(t);var r='<div class="chrome-product-name">'+o+"</div>";$.each(t,function(e,o){debug&&console.log(e),r+='<div class="session_title active">'+e+"</div>",$.each(o,function(e,o){r+='<div class="attr_part" id="Width"><div class="attr_title">'+e+"</div>",Array.isArray(o.value)?o.value.forEach(function(e,o){r+='<div class="attr-value  color-circle">*'+e.code+"</br>",r+='<div class="attr_value attr_value_left">'+e.color_name+"</div> </div>"}):r+='<div class="attr_value">'+o.value+"</div>",r+="</div>"})}),debug&&console.log(r),$(".chrome-product").html(r)})}function getCaretPosition(e){var o,t,r=0;if(window.getSelection)(o=window.getSelection()).rangeCount&&(t=o.getRangeAt(0)).commonAncestorContainer.parentNode==e&&(r=t.endOffset);else if(document.selection&&document.selection.createRange&&(t=document.selection.createRange()).parentElement()==e){var n=document.createElement("span");e.insertBefore(n,e.firstChild);var i=t.duplicate();i.moveToElementText(n),i.setEndPoint("EndToEnd",t),r=i.text.length}return r}$(document).ready(function(){initHeightLightTool(),setInterval(initHeightLightTool,3e3),$body.on({mouseenter:function(){renderToolipTA($(this))}},".chromeTooltipMark.markForTA"),$body.on({mouseenter:function(){renderToolipCE($(this))}},".chromeTooltipMark.markForCE"),$body.on({mouseleave:function(e){hideChromeTooltip()}},"#techspecs_iframe")});